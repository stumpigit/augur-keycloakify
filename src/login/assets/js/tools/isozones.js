import{Map,View}from"ol";import{Tile as TileLayer,Vector as VectorLayer}from"ol/layer";import WebGLTileLayer from"ol/layer/WebGLTile";import{XYZ,GeoTIFF}from"ol/source";import{defaults as defaultControls,ScaleLine}from"ol/control";import{register}from"ol/proj/proj4";import proj4 from"proj4";import{CupertinoPane,CupertinoSettings}from"cupertino-pane";proj4.defs("EPSG:2056","+proj=somerc +lat_0=46.95240555555556 +lon_0=7.439583333333333 +k_0=1 +x_0=2600000 +y_0=1200000 +ellps=bessel +towgs84=674.374,15.056,405.346,0,0,0,0 +units=m +no_defs"),register(proj4);const backgroundLayer=new TileLayer({id:"background-layer",source:new XYZ({url:"https://wmts.geo.admin.ch/1.0.0/ch.swisstopo.pixelkarte-farbe/default/current/3857/{z}/{x}/{y}.jpeg"})}),view=new View({projection:"EPSG:2056",center:[2605764,1177523],zoom:14}),map=new Map({target:"map",controls:defaultControls().extend([new ScaleLine({units:"metric"})]),layers:[backgroundLayer],view:view});let mapcontainer=document.getElementById("mapcontainer"),body=document.querySelector("body"),mapcontainer_bounding=mapcontainer.getBoundingClientRect(),body_bounding=body.getBoundingClientRect(),settings={parentElement:mapcontainer,breaks:{middle:{enabled:!1},bottom:{enabled:!0,height:body_bounding.height-mapcontainer_bounding.height+50}},initialBreak:"bottom",buttonDestroy:!1},myPane=new CupertinoPane(".cupertino-pane",settings);(async()=>{await myPane.present({animate:!0})})();const styleFunction=function(e){return styles[e.getGeometry().getType()]};function getStatus(e){fetch("./task/"+e,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{new Date;let t=e.task_status+" ";"SUCCESS"!=e.task_status&&(t+=""+JSON.stringify(e.task_result.text)),document.getElementById("progresstext").innerHTML=t;var n,o=e.task_status;if("SUCCESS"===o&&(console.log(e),n=new GeoTIFF({sources:[{url:"./data/temp/"+e.task_id+"/isozones_cog.tif"}],normalize:!1}),n=new WebGLTileLayer({source:n,name:"isozone",style:{color:["interpolate",["linear"],["band",1],-1,[0,0,0,0],0,[255,0,0],5,[255,210,210]]}}),map.getLayers().forEach(e=>{e&&e.get("name")&&"isozone"==e.get("name")&&map.removeLayer(e)}),map.addLayer(n)),"SUCCESS"===o||"FAILURE"===o)return map.getTargetElement().classList.remove("spinner"),!1;setTimeout(function(){getStatus(e.task_id)},1e3)}).catch(e=>console.log(e))}map.on("singleclick",function(e){fetch("./isozones/?northing="+e.coordinate[0]+"&easting="+e.coordinate[1],{method:"GET"}).then(e=>e.json()).then(e=>{const t=new Date;document.getElementById("progresstext").innerHTML=t.toUTCString()+" Starting",map.getTargetElement().classList.add("spinner"),getStatus(e.task_id)})});