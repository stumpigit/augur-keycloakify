var GeoSearchControl=window.GeoSearch.GeoSearchControl,OpenStreetMapProvider=window.GeoSearch.OpenStreetMapProvider;let map,augurLayer,currentFocus,locationData,latlong,tilesPeriod=10,defaultYear=2030,uncertainty=!1;const provider=new OpenStreetMapProvider,locationIcon=new L.icon({iconUrl:"assets/images/tools/location_pin.svg",shadowUrl:"assets/images/tools/location_pin_shadow.svg",iconSize:[48,48],shadowSize:[48,48],iconAnchor:[24,48],shadowAnchor:[24,48],popupAnchor:[24,0]}),marker=new L.marker([0,0],{icon:locationIcon});async function init(){document.addEventListener("DOMContentLoaded",function(){}),window.addEventListener("popstate",e=>{buildPage({pageKey:e.state.pageKey},!1)});var e,t,a=L.tileLayer("https://tiles.stadiamaps.com/tiles/stamen_toner_lite/{z}/{x}/{y}{r}.png",{attribution:'Map tiles by <a href="http://augur.world">AUGUR</a> and &copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://www.stamen.com/" target="_blank">Stamen Design</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/about/" target="_blank">OpenStreetMap contributors</a>',subdomains:"abcd",minZoom:0,maxZoom:20,opacity:.5,ext:"png"}),n=(Boolean(location.search)&&location.search.includes("period")&&(e=new URLSearchParams(location.search).get("period"),["10","20","30","100"].includes(e)&&(tilesPeriod=e),document.querySelector("select[name=tiles_period]").value=tilesPeriod),augurLayer=L.tileLayer(`https://augur.world/tilesaugur/tiles${tilesPeriod}/{z}/{x}/{y}.png`,{detectRetina:!0,opacity:1}),map=new L.map("map__contents__tiles",{center:new L.LatLng(0,0),zoom:4,minZoom:4,maxZoom:9,zoomControl:!1,maxBounds:[[-50,-1/0],[50,1/0]],layers:[augurLayer,a]}),Boolean(location.search)&&location.search.includes("lat")&&location.search.includes("lng")&&(e=new URLSearchParams(location.search).get("lat"),a=new URLSearchParams(location.search).get("lng"),location.search.includes("year")&&(n=new URLSearchParams(location.search).get("year"),["2030","2050","2090"].includes(n)&&(defaultYear=n)),setLocation([e,a],defaultYear)),is_touch_enabled()?map.addEventListener("contextmenu",e=>setLocation([e.latlng?.lat,e?.latlng?.lng])):map.addEventListener("click",e=>setLocation([e.latlng?.lat,e?.latlng?.lng])),document.querySelectorAll("#aside header nav a"));for(t of n)t.addEventListener("click",onClickPageLink);const l=document.querySelector('#map__contents__navigate__search .icon[alt="Clear"]'),i=(l.addEventListener("click",clearLocation),document.querySelector("#map__contents__details__drag-handle")),o=(i.addEventListener("click",handleDetailsPosition),document.getElementById("map__contents__period")),r=(o.addEventListener("change",handlePeriodValue),document.querySelector("button[name=share]")),c=(r.addEventListener("click",handleShareClick),document.querySelector("button[name=download]")),s=(c.addEventListener("click",download),document.querySelector("button#getLocation")),d=(s.addEventListener("click",getCurrentLocation),document.querySelector("select[name=climate_change_period]")),u=(d.value=defaultYear,d.addEventListener("change",handleClimateChange),document.querySelector("input[name=uncertainty_check]")),p=(u.addEventListener("change",handleUncertainty),document.getElementById("map__contents__navigate__search__input"));p.addEventListener("input",debounce(handleFind.bind(p),300)),p.addEventListener("keydown",handleKeyDownFind),fallBackLangFile=await languages.en.source,await translatePage()}function getCurrentLocation(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(getToPosition)}async function getToPosition(e){map.flyTo([e.coords.latitude,e.coords.longitude],5),marker.setLatLng([e.coords.latitude,e.coords.longitude]).addTo(map),await setLocation([e.coords.latitude,e.coords.longitude])}function handleShareClick(){var e=new URL(location.href),t=new URLSearchParams({lat:latlong[0],lng:latlong[1],period:tilesPeriod,year:defaultYear}),e=new URL(""+e.origin+e.pathname+"?"+t),t=document.createElement("textarea");t.style.position="fixed",t.style.top=0,t.style.left=0,t.value=e,document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),document.querySelector("label[class=tooltiptext]").style.visibility="visible",setTimeout(function(){document.querySelector("label[class=tooltiptext]").style.visibility="hidden"},1e3)}catch(e){console.log("Oops, unable to copy")}document.body.removeChild(t)}function handleClimateChange(e){defaultYear=e.target.value;e=drawPrecipitactionGraphDOM(locationData,defaultYear,uncertainty);const t=document.getElementById("map__contents__details__graph");t.replaceChildren(e)}function navigateToCurrentURL(){var e,t=window.location.pathname;let a=defaultPage;for(e in pages)pages[e].slug===t&&(a=e);buildPage({pageKey:a},!1)}function closeAllLists(t){var a=document.getElementById("map__contents__navigate__search__input");let n=document.getElementsByClassName("autocomplete-items");for(let e=0;e<n.length;e++)t!=n[e]&&t!=a&&n[e].parentNode.removeChild(n[e])}function handleKeyDownFind(e){let t=document.getElementById(this.id+"autocomplete-list");t=t&&t.getElementsByTagName("div"),40==e.keyCode?(currentFocus++,addActive(t)):38==e.keyCode?(currentFocus--,addActive(t)):13==e.keyCode&&(e.preventDefault(),-1<currentFocus&&t&&t[currentFocus].click())}function debounce(t,a=300){let n;return(...e)=>{clearTimeout(n),n=setTimeout(()=>{t.apply(this,e)},a)}}function generateFileContent(){const t=Object.keys(locationData?.period),e=Object.keys(locationData?.period[t[0]]?.years);var a=e.map(n=>{let e=[n+"-Year in today: "+locationData?.period[t[0]]?.years[n].present];return e=e.concat(t.map((e,t)=>{var a="";return a+=n+`-Year in ${e}: `+locationData?.period[e]?.years[n].climate_change}))}).reduce((e,t)=>e.concat(...t),[]).join("\n");return`# Data downloaded by augur.world
# Selected coordinates:
lat = ${latlong[0]}, lon = ${latlong[1]}
# Precipitation data
${a}
`}function download(){var e=document.createElement("a");e.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(generateFileContent())),e.setAttribute("download",latlong[0]+" - "+latlong[1]+".txt"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)}function addActive(e){if(!e)return!1;removeActive(e),e[currentFocus=(currentFocus=currentFocus>=e.length?0:currentFocus)<0?e.length-1:currentFocus].classList.add("autocomplete-active")}function removeActive(e){for(var t=0;t<e.length;t++)e[t].classList.remove("autocomplete-active")}async function handleFind(e){const t=await provider.search({query:e.target.value}),a=this;let n,l,i,o=this.value;if(!o)return!1;closeAllLists(),currentFocus=-1,(n=document.createElement("div")).setAttribute("id",this.id+"autocomplete-list"),n.setAttribute("class","autocomplete-items"),this.parentNode.appendChild(n);var r=4<t.length?4:t.length;for(i=0;i<r;i++)(l=document.createElement("DIV")).innerHTML="<strong>"+t[i].label.substr(0,o.length)+"</strong>",l.innerHTML+=t[i].label.substr(o.length),l.innerHTML+="<input type='hidden' value='"+t[i].label+"' name='label' />",l.innerHTML+=`<input type='hidden' value='${t[i].y}' name='lat' />`,l.innerHTML+=`<input type='hidden' value='${t[i].x}' name='lng' />`,l.addEventListener("click",async function(e){a.value=this.querySelector("input[name=label]")?.value;var t=[this.querySelector("input[name=lat]")?.value,this.querySelector("input[name=lng]")?.value];closeAllLists(),await setLocation(t)}),n.appendChild(l)}function handlePeriodValue(e){tilesPeriod=e.target.value,augurLayer.setUrl(`https://augur.world/tilesaugur/tiles${tilesPeriod}/{z}/{x}/{y}.png`)}function handleDetailsPosition(e){const t=document.getElementById("map");t.hasAttribute("data-details-as-sheet")?delete t.dataset.detailsAsSheet:t.dataset.detailsAsSheet=""}async function buildPage(e,t){var a,n=e.pageKey,n=pages[n];document.title="Augur | "+n.title;const l=document.querySelector("#aside nav");for(a of l.children)delete a.dataset.selected;l.querySelector(`a[to="${n.slug}"]`).dataset.selected="";var i=new URLSearchParams(location.search).get("lang");t&&history.pushState(e,"",n.slug+(i?"?lang="+i:""));const o=document.getElementById("aside__content"),r=await n.module;t=await r.default();o.replaceChildren(t),r.init?.(changeLanguage);const c=new URLSearchParams(location.search).get("lang");c&&"null"!==c&&document.querySelectorAll(".languages-inputes-container input").forEach(e=>{e.value===c?e.setAttribute("checked","checked"):e.removeAttribute("checked")}),await translatePage()}function changeLanguage(){document.querySelector(".languages-inputes-container").addEventListener("click",e=>{e.stopPropagation(),e.preventDefault();let t=null;if("LABEL"===e.target.nodeName?t=e.target.querySelector("input"):"INPUT"===e.target.nodeName&&(t=e.target),t){document.querySelectorAll(".languages-inputes-container input").forEach(e=>{e.removeAttribute("checked")}),t.setAttribute("checked","checked");const a=new URL(location);a.searchParams.set("lang",t?.value),document.location.href=a}})}function onClickPageLink(e){e.preventDefault();const t=e.target.closest("a");var a=t.getAttribute("to");let n;for(const l in pages)pages[l].slug===a&&(n=l);buildPage({pageKey:n},!0)}function handleUncertainty(e){uncertainty=e.currentTarget.checked;e=drawPrecipitactionGraphDOM(locationData,defaultYear,uncertainty);const t=document.getElementById("map__contents__details__graph");t.replaceChildren(e)}async function setLocation(e,t=2030){marker.setLatLng(e).addTo(map),latlong=e,document.querySelector("div[class=lds-dual-ring]").style.display="inline-block",document.getElementById("map__contents__details__graph").style.display="none",map.flyTo(e,5);const a=document.getElementById("map");delete a.dataset.detailsClosed;e=drawPrecipitactionGraphDOM(locationData=await fetchLocationData(e),t,uncertainty);const n=document.getElementById("map__contents__details__graph");document.querySelector("select[name=climate_change_period]").selectedIndex=0,n.replaceChildren(e)}function clearLocation(e){const t=document.getElementById("map"),a=(t.dataset.detailsClosed="",t.dataset.detailsAsSheet="",closeAllLists(),document.getElementById("map__contents__navigate__search__input"));a.value=null}function is_touch_enabled(){return"ontouchstart"in window||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints}function toggleAside(e){var t="data-aside-closed";const a=document.getElementById("app");"close"!==e&&("open"===e||a.hasAttribute(t))?a.removeAttribute(t):a.setAttribute(t,"")}async function fetchLocationData(e){const t=await fetch(`${process.env.SERVER}/location?lat=${e[0]}&lng=`+e[1]);return t.json()}function drawPrecipitationGraphSVG(e){var t,a=2030;const n=[];for(t in e.period[a].years)n.push(e.period[a].years[t].present),n.push(e.period[a].years[t].climate_change);var l=Math.max(...n),i=Object.keys(e.period[a].years).length,o=300/l,r="http://www.w3.org/2000/svg";const c=document.createElementNS(r,"svg");c.classList.add("graph"),c.setAttributeNS(null,"height",330),c.setAttributeNS(null,"shape-rendering","crispEdges"),c.setAttributeNS(null,"version","1.1");let s=document.createElementNS(r,"g");s.classList.add("precipitation-graph__scale"),c.appendChild(s);var d=10*o,u=300/d;for(let l=0;l<=u;l++){var p=l*d;let e=document.createElementNS(r,"g"),t=(e.setAttributeNS(null,"transform",`translate( 0, ${p} )`),s.appendChild(e),document.createElementNS(r,"line")),a=(t.classList.add("row-line"),t.setAttributeNS(null,"x1","0"),t.setAttributeNS(null,"x2","100%"),t.setAttributeNS(null,"y1",0),t.setAttributeNS(null,"y2",0),e.appendChild(t),document.createElementNS(r,"rect")),n=(a.classList.add("row-labelbg"),a.setAttributeNS(null,"x",0),a.setAttributeNS(null,"y",15-d),a.setAttributeNS(null,"width",30),a.setAttributeNS(null,"height",15),e.appendChild(a),document.createElementNS(r,"text"));n.classList.add("row-label"),n.setAttributeNS(null,"x",0),n.setAttributeNS(null,"y",15-d/2),n.textContent=parseInt(10*(u-l)),e.appendChild(n)}let m=document.createElementNS(r,"g");m.classList.add("precipitation-graph__columns"),c.appendChild(m);var h,g=e.period[a].years,y=100/(i+1);let v=1;for(h in g){var L=g[h].present,_=o*L,b=v*y;let e=document.createElementNS(r,"g"),t=(e.classList.add("column"),e.setAttributeNS(null,"transform","translate( 0, 0 )"),m.appendChild(e),document.createElementNS(r,"rect")),a=(t.classList.add("rect-present"),t.setAttributeNS(null,"x",b+"%"),t.setAttributeNS(null,"y",0),t.setAttributeNS(null,"height",_),e.appendChild(t),document.createElementNS(r,"text")),n=(a.classList.add("column-label"),a.setAttributeNS(null,"x",b+"%"),a.setAttributeNS(null,"y",15),a.textContent=h+"y",e.appendChild(a),document.createElementNS(r,"text"));n.classList.add("column-value"),n.setAttributeNS(null,"x",b+"%"),n.setAttributeNS(null,"y",_),n.textContent=L,e.appendChild(n),v++}return c}function drawPrecipitactionGraphDOM(e,t=2030,l=!1){let n=20;document.querySelector("div[class=lds-dual-ring]").style.display="none",document.getElementById("map__contents__details__graph").style.display="inline-block";const a=[];for(var i in e.period[t].years){var o=e.period[t].years[i].present;a.push(o),a.push(e.period[t].years[i].climate_change),l&&a.push(1.3*o)}var r,c=Math.max(...a),c=(299<c&&(n=50),599<c&&(n=100),Math.ceil(c/n)*n),s=c/n,d=e.period[t].years,u=100/c;let p=document.createElement("div"),m=(p.classList.add("graph-precip"),document.createElement("div")),h=(m.classList.add("header"),p.appendChild(m),document.createElement("div")),g=(h.classList.add("units"),h.innerHTML=""+translate("unit"),m.appendChild(h),document.createElement("ul")),y=(g.classList.add("legend"),g.innerHTML=`<li>${translate("climate_change")}</li>
    <li>${translate("present")}</li>`,m.appendChild(g),document.createElement("div")),v=(y.classList.add("row-label-section"),p.appendChild(y),document.createElement("div"));v.classList.add("row-lines-section"),p.appendChild(v);for(let a=0;a<=s;a++){let e=document.createElement("div"),t=(e.classList.add("row-label"),e.dataset.value=a*n,y.appendChild(e),document.createElement("div"));t.classList.add("row-line"),v.appendChild(t)}let L=document.createElement("div"),_=(L.classList.add("column-label-section"),p.appendChild(L),document.createElement("div")),b=(_.classList.add("graph-section"),p.appendChild(_),document.createElement("div"));for(r in b.classList.add("graph-section"),b.classList.add("graph-section-layer"),p.appendChild(b),d){let e=document.createElement("div"),t=(e.classList.add("column-label"),e.innerHTML=r,L.appendChild(e),d[r].climate_change),a=t*u,n=document.createElement("div");if(n.classList.add("graph-item"),n.classList.add("climate-item"),n.style.height=a+"%",n.innerHTML=t,_.appendChild(n),l){n.innerHTML="";var f=t=d[r].present,S=.7*t,f=(t*=1.3,Math.ceil(100-100*f/t));a=t*u,n=document.createElement("div");const w=document.createElement("div"),E=document.createElement("div"),C=document.createElement("div"),A=document.createElement("span");n.classList.add("graph-item"),n.style.height=a+"%",w.classList.add("present-item"),w.style.height=78-f+"%",E.classList.add("uncert-item"),E.style.height=f+"%",C.style.height="22%",C.classList.add("overlap-item"),A.classList.add("overlap-item-span");f=Math.ceil(t),S=Math.floor(S);A.innerText=S,E.innerHTML=`<div style="color: black; margin-top: -16px">${f}</div><div style="width: 53%; height: 100%; margin-top: 0px; border-right: #17527c 1px solid; color: black">
      </div>`,C.innerHTML='<div style="width: 3%; height: 100%; margin: 0 auto; border-right: #17527c 1px solid;">&nbsp;</div>',C.appendChild(A),n.appendChild(E),n.appendChild(C),n.appendChild(w),b.appendChild(n)}else t=d[r].present,a=t*u,(n=document.createElement("div")).classList.add("graph-item"),n.classList.add("present-item"),n.style.height=a+"%",n.innerHTML=t,b.appendChild(n)}return p}init(),Number.prototype.map=function(e,t,a,n){return(this-e)*(n-a)/(t-e)+a};